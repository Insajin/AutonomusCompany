name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install semantic-release
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Post release summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('‚úÖ Semantic release completed successfully');

      - name: Create issue on release failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `üö® Release Failed: Semantic Release - ${date}`;

            // Check for existing issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure,area/ci',
              per_page: 5
            });

            const isDuplicate = existingIssues.data.some(issue =>
              issue.title.includes('Release Failed') && issue.title.includes(date)
            );

            if (isDuplicate) {
              console.log('Duplicate issue found, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## üî¥ Semantic Release Failure Report

**Workflow**: ${context.workflow}
**Job**: release
**Trigger**: ${context.eventName}
**Branch**: ${context.ref}
**Commit**: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
**Author**: @${context.actor}
**Timestamp**: ${new Date().toISOString()}

### üìä Error Details

The semantic release process failed. This prevents automatic versioning and changelog generation.

**Workflow Run**: [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

### üîç Common Causes

- **Invalid commit messages**: Not following [Conventional Commits](https://www.conventionalcommits.org/)
  - Should be: \`feat:\`, \`fix:\`, \`chore:\`, etc.
- **GitHub token permissions**: Token lacks required permissions
- **Release configuration**: Issues in \`.releaserc\` or package.json
- **Git history**: Merge conflicts or detached HEAD
- **NPM registry issues**: Network/authentication problems
- **Already released**: No new commits since last release

### ‚úÖ Action Required

1. **Check commit messages** in the workflow run:
   - Verify they follow conventional commits format
   - At least one \`feat:\` or \`fix:\` commit is needed for release
2. **Verify GITHUB_TOKEN permissions**:
   - Should have \`contents: write\` permission
3. **Check semantic-release configuration**:
   - Review \`.releaserc\` or package.json config
4. **Review git history**: Ensure no merge conflicts
5. **Manual release** (if needed):
   \`\`\`bash
   npm run release
   \`\`\`

### üìö Resources

- [Conventional Commits Spec](https://www.conventionalcommits.org/)
- [Semantic Release Docs](https://semantic-release.gitbook.io/)
- [Troubleshooting Guide](https://semantic-release.gitbook.io/semantic-release/support/troubleshooting)

### üîó Related

- [CI Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
- [Commit](${context.payload.repository.html_url}/commit/${context.sha})
- [Releases](${context.payload.repository.html_url}/releases)

---
ü§ñ *Auto-generated by deployment failure automation*`,
              labels: ['deployment-failure', 'bug', 'automated', 'area/ci'],
              assignees: ['Insajin']
            });
