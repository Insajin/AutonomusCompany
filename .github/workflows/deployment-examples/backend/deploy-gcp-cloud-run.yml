# ‚ö†Ô∏è  DEPLOYMENT EXAMPLE: GCP Cloud Run (Serverless Containers)
#
# üìå HOW TO USE THIS FILE:
# 1. Enable Cloud Run API in GCP Console
# 2. Create service account with Cloud Run Admin role
# 3. Copy to: .github/workflows/deploy-gcp-cloud-run.yml
# 4. Add required secrets (see below)
# 5. Ensure Dockerfile exists in backend/
# 6. Push to trigger deployment
#
# üìã REQUIRED SECRETS (Settings > Secrets and variables > Actions):
#   - GCP_PROJECT_ID: Your GCP project ID
#   - GCP_SERVICE_ACCOUNT_KEY: Service account JSON key (base64 encoded)
#   - GCP_REGION: e.g., us-central1
#   - CLOUD_RUN_SERVICE: Service name
#
# üìö Documentation: https://cloud.google.com/run/docs
# üí∞ Pricing: Free tier (2 million requests/month), then $0.00002400/request
# ‚ö° Benefits:
#   - Serverless (only pay for usage)
#   - Automatic scaling (0 to thousands)
#   - No server management
#   - Integrated with GCP ecosystem
# ‚ö†Ô∏è  Considerations:
#   - Cold starts (though minimal)
#   - Request timeout limits (max 60 min)
#   - GCP-specific

name: Deploy to GCP Cloud Run

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '!backend/**/*.md'

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Authorize Docker push
        run: gcloud auth configure-docker

      - name: Build Docker image
        run: |
          cd backend
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }} .
          docker tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }} \
                     gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:latest

      - name: Push to Google Container Registry
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ secrets.CLOUD_RUN_SERVICE }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --quiet

      - name: Report deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Successfully deployed to Cloud Run"
            echo "üåê Service is now live"
            SERVICE_URL=$(gcloud run services describe ${{ secrets.CLOUD_RUN_SERVICE }} \
              --platform managed \
              --region ${{ secrets.GCP_REGION }} \
              --format 'value(status.url)')
            echo "üîó URL: $SERVICE_URL"
          else
            echo "‚ùå Deployment to Cloud Run failed"
          fi
