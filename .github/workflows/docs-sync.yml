name: Documentation Sync

# Trigger when code is merged to main
on:
  push:
    branches: [main]
    paths:
      - 'frontend/src/**'
      - 'backend/src/**'
      - '!**/*.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis

      - name: Get changed files
        id: changed_files
        run: |
          # Get files changed in the last commit
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Analyze changes for documentation impact
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changedFiles = fs.readFileSync('changed_files.txt', 'utf8').split('\n').filter(f => f);

            // Check if changes affect APIs or models
            const needsDocUpdate = changedFiles.some(file =>
              file.includes('/api/') ||
              file.includes('/models/') ||
              file.includes('/routes/') ||
              file.includes('/endpoints/')
            );

            core.setOutput('needs_update', needsDocUpdate);
            core.setOutput('files', changedFiles.join(','));

      - name: Skip if no documentation needed
        if: steps.analyze.outputs.needs_update != 'true'
        run: |
          echo "No documentation updates needed for these changes"
          exit 0

      - name: Generate documentation updates
        if: steps.analyze.outputs.needs_update == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: 'document'
          files: ${{ steps.analyze.outputs.files }}
          output_dir: 'docs/api/'

      - name: Create documentation PR
        if: steps.analyze.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: update API documentation

            Auto-generated documentation updates based on code changes.

            Triggered-By: ${{ github.sha }}
            Co-Authored-By: Claude <noreply@anthropic.com>
          title: "docs: Update API documentation"
          body: |
            ## Documentation Updates

            This PR updates documentation based on recent code changes.

            **Triggering commit**: ${{ github.sha }}
            **Changed files**: ${{ steps.analyze.outputs.files }}

            **Review checklist**:
            - [ ] Documentation accurately reflects code changes
            - [ ] All new endpoints/functions are documented
            - [ ] Examples are clear and correct

            ðŸ¤– Auto-generated by Documentation Sync workflow
          branch: docs/auto-update-${{ github.run_number }}
          labels: documentation, automated
          delete-branch: true
