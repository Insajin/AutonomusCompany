name: Status Label Automation

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, converted_to_draft]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  update-status:
    name: Update Status Labels
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Add status label to new issues
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status/backlog']
            });

      - name: Add status label to new PRs
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isDraft = context.payload.pull_request.draft;
            const label = isDraft ? 'status/draft' : 'status/in-progress';

            await github.rest.issues.addLabels({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            });

      - name: Update PR status labels
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            let newLabel = '';
            const statusLabels = ['status/draft', 'status/in-progress', 'status/in-review', 'status/approved', 'status/done'];

            // Determine new status label based on PR state
            if (pr.draft) {
              newLabel = 'status/draft';
            } else if (pr.merged) {
              newLabel = 'status/done';
            } else if (context.payload.review?.state === 'approved') {
              newLabel = 'status/approved';
            } else if (pr.requested_reviewers && pr.requested_reviewers.length > 0) {
              newLabel = 'status/in-review';
            } else if (!pr.draft && !pr.merged && !pr.closed) {
              newLabel = 'status/in-progress';
            }

            if (!newLabel) return;

            console.log(`Updating PR #${pr.number} status to: ${newLabel}`);

            // Remove old status labels
            const currentLabels = pr.labels.map(l => l.name);
            for (const oldLabel of statusLabels) {
              if (currentLabels.includes(oldLabel) && oldLabel !== newLabel) {
                try {
                  await github.rest.issues.removeLabel({
                    issue_number: pr.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: oldLabel
                  });
                } catch (error) {
                  console.log(`Could not remove label ${oldLabel}`);
                }
              }
            }

            // Add new status label
            if (!currentLabels.includes(newLabel)) {
              await github.rest.issues.addLabels({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [newLabel]
              });
            }

      - name: Update issue status on close
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            console.log(`Issue #${issue.number} closed`);

            // Add "Done" label
            await github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status/done']
            });

      - name: Update issue status on reopen
        if: github.event_name == 'issues' && github.event.action == 'reopened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            console.log(`Issue #${issue.number} reopened`);

            // Remove "Done" label and add "In Progress"
            try {
              await github.rest.issues.removeLabel({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'status/done'
              });
            } catch (error) {
              console.log('Done label not found');
            }

            await github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status/in-progress']
            });

      - name: Comment on status update
        if: (github.event_name == 'issues' || github.event_name == 'pull_request') && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const isIssue = context.eventName === 'issues';
            const number = isIssue ? context.issue.number : context.payload.pull_request.number;
            const type = isIssue ? 'issue' : 'PR';
            const label = isIssue ? '`status/backlog`' : (context.payload.pull_request?.draft ? '`status/draft`' : '`status/in-progress`');

            await github.rest.issues.createComment({
              issue_number: number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üè∑Ô∏è Status label ${label} has been added automatically.\n\n**Next steps**:\n${isIssue ? '- Review and triage\n- Assign to sprint\n- Start work' : '- Request review\n- Address feedback\n- Merge when approved'}\n\n_Status will be updated automatically as work progresses._`
            });
