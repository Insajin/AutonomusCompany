name: Deploy

# Deploy when code is merged to main
on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

  deploy-frontend:
    name: Deploy Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build
        env:
          CI: true

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
          vercel-args: '--prod'

      - name: Report deployment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            console.log(`${status} Frontend deployment ${job.status}`);

      - name: Create issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `üö® Deployment Failed: Frontend - ${date}`;

            // Check for existing issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure,area/frontend',
              per_page: 5
            });

            const isDuplicate = existingIssues.data.some(issue =>
              issue.title.includes(date) && issue.body.includes(context.sha.substring(0, 7))
            );

            if (isDuplicate) {
              console.log('Duplicate issue found, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## üî¥ Frontend Deployment Failure Report

**Workflow**: ${context.workflow}
**Job**: deploy-frontend
**Trigger**: ${context.eventName}
**Branch**: ${context.ref}
**Commit**: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
**Author**: @${context.actor}
**Timestamp**: ${new Date().toISOString()}

### üìä Error Details

The frontend deployment to Vercel failed during execution. This requires immediate attention.

**Workflow Run**: [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

### üîç Common Causes

- Build errors (TypeScript, ESLint)
- Missing environment variables
- Vercel token/credentials issues
- Dependency installation failures
- Out of memory errors

### ‚úÖ Action Required

1. **Check the workflow logs** for specific error messages
2. **Verify Vercel secrets** are correctly configured:
   - \`VERCEL_TOKEN\`
   - \`VERCEL_ORG_ID\`
   - \`VERCEL_PROJECT_ID\`
3. **Test locally**: \`cd frontend && npm run build\`
4. **Fix the issue** and push again or manually re-run the workflow

### üîó Related

- [CI Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
- [Commit](${context.payload.repository.html_url}/commit/${context.sha})

---
ü§ñ *Auto-generated by deployment failure automation*`,
              labels: ['deployment-failure', 'critical', 'bug', 'automated', 'area/frontend'],
              assignees: ['Insajin']
            });

  deploy-backend:
    name: Deploy Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/app-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/app-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Report deployment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            console.log(`${status} Backend deployment ${job.status}`);

      - name: Create issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `üö® Deployment Failed: Backend - ${date}`;

            // Check for existing issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure,area/backend',
              per_page: 5
            });

            const isDuplicate = existingIssues.data.some(issue =>
              issue.title.includes(date) && issue.body.includes(context.sha.substring(0, 7))
            );

            if (isDuplicate) {
              console.log('Duplicate issue found, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## üî¥ Backend Deployment Failure Report

**Workflow**: ${context.workflow}
**Job**: deploy-backend
**Trigger**: ${context.eventName}
**Branch**: ${context.ref}
**Commit**: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
**Author**: @${context.actor}
**Timestamp**: ${new Date().toISOString()}

### üìä Error Details

The backend Docker build/push to Docker Hub failed during execution. This requires immediate attention.

**Workflow Run**: [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

### üîç Common Causes

- Docker build errors
- Missing Dockerfile or invalid syntax
- Docker Hub authentication issues
- Dependency installation failures in container
- Registry quota exceeded
- Network connectivity issues

### ‚úÖ Action Required

1. **Check the workflow logs** for specific error messages
2. **Verify Docker Hub secrets** are correctly configured:
   - \`DOCKER_USERNAME\`
   - \`DOCKER_PASSWORD\`
3. **Test locally**: \`cd backend && docker build -t test .\`
4. **Check Docker Hub quota**: [Docker Hub Dashboard](https://hub.docker.com/)
5. **Fix the issue** and push again or manually re-run the workflow

### üîó Related

- [CI Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
- [Commit](${context.payload.repository.html_url}/commit/${context.sha})
- [Docker Hub](https://hub.docker.com/)

---
ü§ñ *Auto-generated by deployment failure automation*`,
              labels: ['deployment-failure', 'critical', 'bug', 'automated', 'area/backend'],
              assignees: ['Insajin']
            });
