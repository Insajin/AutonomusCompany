name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read

# Prevent duplicate runs for the same PR
concurrency:
  group: auto-merge-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number }}
  cancel-in-progress: true

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;

            if (context.eventName === 'pull_request') {
              pr = context.payload.pull_request;
            } else if (context.eventName === 'pull_request_review') {
              pr = context.payload.pull_request;
            } else if (context.eventName === 'check_suite') {
              const prs = context.payload.check_suite.pull_requests;
              if (prs.length === 0) {
                console.log('No PR associated with this check suite');
                return;
              }
              const prData = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prs[0].number
              });
              pr = prData.data;
            }

            if (!pr) {
              console.log('No PR found');
              return;
            }

            core.setOutput('number', pr.number);
            core.setOutput('author', pr.user.login);
            core.setOutput('title', pr.title);
            core.setOutput('draft', pr.draft);
            core.setOutput('mergeable', pr.mergeable);
            return pr.number;

      - name: Check auto-merge conditions
        if: steps.pr.outputs.number
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');
            const author = '${{ steps.pr.outputs.author }}';
            const isDraft = '${{ steps.pr.outputs.draft }}' === 'true';

            if (isDraft) {
              console.log('PR is draft, skipping auto-merge');
              return;
            }

            // Get PR details
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check if PR is from Dependabot
            const isDependabot = author === 'dependabot[bot]' || author.includes('dependabot');

            // Get PR labels
            const labels = pr.data.labels.map(l => l.name);
            const hasAutoMergeLabel = labels.includes('automerge');

            // Get reviews
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const approvedReviews = reviews.data.filter(r => r.state === 'APPROVED');
            const changesRequested = reviews.data.some(r => r.state === 'CHANGES_REQUESTED');
            const hasApproval = approvedReviews.length > 0;

            // Get check runs
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });

            const allChecksPassed = checks.data.check_runs.every(
              check => check.status === 'completed' && check.conclusion === 'success'
            );

            // Determine if we should auto-merge
            let shouldMerge = false;
            let reason = '';

            if (changesRequested) {
              console.log('Changes requested, cannot auto-merge');
              reason = 'Changes requested on PR';
            } else if (!allChecksPassed) {
              console.log('Not all checks passed');
              reason = 'CI checks not passing';
            } else if (isDependabot) {
              // Auto-merge Dependabot PRs if checks pass
              shouldMerge = true;
              reason = 'Dependabot PR with passing checks';
            } else if (hasAutoMergeLabel && hasApproval) {
              // Auto-merge if labeled and approved
              shouldMerge = true;
              reason = 'Has automerge label and approval';
            }

            core.setOutput('should_merge', shouldMerge);
            core.setOutput('reason', reason);
            core.setOutput('is_dependabot', isDependabot);
            return shouldMerge;

      - name: Auto-approve Dependabot
        if: steps.check.outputs.is_dependabot == 'true' && steps.check.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');

            // Check if already approved
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const alreadyApproved = reviews.data.some(
              r => r.user.login === 'github-actions[bot]' && r.state === 'APPROVED'
            );

            if (!alreadyApproved) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '‚úÖ Auto-approved by GitHub Actions\n\nDependabot PR with passing CI checks.'
              });
            }

      - name: Merge PR
        if: steps.check.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');
            const reason = '${{ steps.check.outputs.reason }}';

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash', // or 'merge' or 'rebase'
                commit_title: `${{ steps.pr.outputs.title }} (#${prNumber})`,
                commit_message: `Auto-merged: ${reason}`
              });

              console.log(`Successfully merged PR #${prNumber}`);

              // Comment on successful merge
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚úÖ **Auto-merged**\n\nReason: ${reason}\n\nThis PR has been automatically merged because:\n- All CI checks passed\n- Required approvals received\n- No changes requested\n\nüéâ Changes are now deployed!`
              });
            } catch (error) {
              console.error('Failed to merge:', error.message);
              core.setFailed(`Merge failed: ${error.message}`);
            }

      - name: Comment on why not merged
        if: steps.check.outputs.should_merge == 'false' && steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');
            const reason = '${{ steps.check.outputs.reason }}';

            if (!reason) return;

            // Only comment once
            const comments = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const alreadyCommented = comments.data.some(
              c => c.body.includes('‚è∏Ô∏è Auto-merge paused')
            );

            if (!alreadyCommented) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚è∏Ô∏è **Auto-merge paused**\n\nReason: ${reason}\n\n**To enable auto-merge**:\n- Ensure all CI checks pass\n- Get required approvals\n- Add \`automerge\` label (for non-Dependabot PRs)\n- Address any requested changes`
              });
            }
